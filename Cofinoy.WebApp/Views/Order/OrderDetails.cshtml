@model Cofinoy.Services.ServiceModels.OrderDetailsServiceModel
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Order Details";
}

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="~/css/orderDetails.css" asp-append-version="true" />

<div class="order-details-container">
    <a href="/Order/OrderManagement" class="back-link">
        <i class="fas fa-arrow-left"></i> Back to order list
    </a>

    <h2 class="order-title">Order #@Model.InvoiceNumber</h2>
    <p class="order-time">@Model.OrderDate.ToString("MMMM dd, yyyy - hh:mm tt")</p>

    <div class="order-status-badge status-@Model.Status.ToLower().Replace(" ", "-")">
        <i class="fas fa-circle"></i> @Model.Status
    </div>

    <div class="order-details-body">
        <div class="order-items-card">
            <h3>Order Items</h3>
            @foreach (var item in Model.OrderItems)
            {
                <div class="order-item">
                    <div>
                        <strong>@item.ProductName</strong><br />
                        <small>Quantity: @item.Quantity</small><br />

                        @if (item.Customizations != null && item.Customizations.Any())
                        {
                            <div class="customizations-section">
                                @foreach (var customization in item.Customizations)
                                {
                                    <small class="customization-item">
                                        <span class="customization-name">@customization.Name:</span>
                                        <span class="customization-value">@customization.Value</span>
                                        @if (customization.Price > 0)
                                        {
                                            <span class="customization-price">(+₱@customization.Price.ToString("N2"))</span>
                                        }
                                    </small>
                                }
                            </div>
                        }
                        else
                        {
                            @if (!string.IsNullOrEmpty(item.Size) || !string.IsNullOrEmpty(item.Temperature))
                            {
                                <small>
                                    Add-ons: @item.Size@(string.IsNullOrEmpty(item.Size) || string.IsNullOrEmpty(item.Temperature) ? "" : ", ")@item.Temperature
                                </small>
                            }
                            @if (!string.IsNullOrEmpty(item.MilkType))
                            {
                                <br />
                                <small>Milk: @item.MilkType</small>
                            }
                            @if (item.ExtraShots.HasValue && item.ExtraShots.Value > 0)
                            {
                                <br />
                                <small>Extra Shots: @item.ExtraShots</small>
                            }
                            @if (!string.IsNullOrEmpty(item.SweetnessLevel))
                            {
                                <br />
                                <small>Sweetness: @item.SweetnessLevel</small>
                            }
                        }
                    </div>
                    <strong>₱@item.TotalPrice.ToString("N2")</strong>
                </div>
            }

            <div class="price-summary">
                <div><span>Subtotal</span><span>₱@Model.TotalPrice.ToString("N2")</span></div>
                @if (Model.AdditionalRequest == "Discount")
                {
                    <div><span>Discount</span><span>- ₱60.00</span></div>
                }
                <div class="total"><span>TOTAL</span><span>₱@Model.TotalPrice.ToString("N2")</span></div>
            </div>
        </div>

        <div class="customer-info-card">
            <h3>Customer Information</h3>
            <p><i class="fas fa-user"></i> @(Model.CustomerName ?? Model.Nickname ?? "Guest")</p>

            @{
                var email = Model.CustomerInfo?.Email;
                var city = Model.CustomerInfo?.City;
                var country = Model.CustomerInfo?.Country;
                var location = !string.IsNullOrEmpty(city) && !string.IsNullOrEmpty(country) ? $"{city}, {country}" :
                !string.IsNullOrEmpty(city) ? city :
                !string.IsNullOrEmpty(country) ? country : "";
            }

            <p><i class="fas fa-envelope"></i> @(string.IsNullOrEmpty(email) ? "N/A" : email)</p>
            <p><i class="fas fa-map-marker-alt"></i> @(string.IsNullOrEmpty(location) ? "N/A" : location)</p>

            @if (!string.IsNullOrEmpty(Model.AdditionalRequest) && Model.AdditionalRequest != "Discount")
            {
                <hr style="margin: 15px 0; border: none; border-top: 1px solid #eee;" />
                <p><i class="fas fa-comment"></i> Note: @Model.AdditionalRequest</p>
            }
        </div>
    </div>

    <div class="order-footer">
        @{
            var status = Model.Status?.Trim() ?? "Pending";
        }

        @if (status == "Pending")
        {
            <button class="btn-brewing" onclick="validatePending(@Model.Id)">
                <i class="fas fa-fire"></i> Start Brewing
            </button>

            <button class="btn-cancel-outline" onclick="cancelOrder(@Model.Id)">
                <i class="fas fa-times"></i> Cancel Order
            </button>
        }
        else if (status == "Brewing")
        {
            <button class="btn-ready" onclick="markAsReady(@Model.Id)">
                <i class="fas fa-check"></i> Mark as Ready
            </button>
        }
        else if (status == "Ready")
        {
            <button class="btn-serving" onclick="markAsServing(@Model.Id)">
                <i class="fas fa-hand-holding"></i> Mark as Serving
            </button>
        }
        else if (status == "Serving")
        {
            <button class="btn-served" onclick="markAsServed(@Model.Id)">
                <i class="fas fa-check-double"></i> Mark as Served
            </button>
        }
        else if (status == "Served")
        {
            <div class="order-completed-message">
                <i class="fas fa-check-circle"></i> Order Completed Successfully
            </div>
        }
        else if (status == "Cancelled")
        {
            <div class="order-completed-message cancelled">
                <i class="fas fa-times-circle"></i> Order Cancelled
            </div>
        }
    </div>
</div>

<!-- Notification Modal -->
<div id="notificationModal" class="modal-overlay">
    <div class="modal-content">
        <span id="notificationIcon" class="material-icons modal-icon">check_circle</span>
        <h3 id="notificationTitle">Success</h3>
        <p id="notificationMessage">Operation completed successfully</p>
        <button id="notificationOkBtn" class="modal-btn">OK</button>
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div id="cancelConfirmModal" class="modal-overlay">
    <div class="modal-content">
        <span class="material-icons modal-icon" style="color: #ffc107;">warning</span>
        <h3>Confirm Cancellation</h3>
        <p>Are you sure you want to cancel this order? This action cannot be undone.</p>
        <div class="modal-buttons">
            <button id="confirmCancelBtn" class="modal-btn modal-btn-danger">Yes, Cancel Order</button>
            <button id="cancelCancelBtn" class="modal-btn modal-btn-secondary">No, Keep Order</button>
        </div>
    </div>
</div>

<partial name="_Toast" />

<script src="~/js/orderDetails.js" asp-append-version="true"></script>

<script>
    const customerInfo = {
        orderId: @Model.Id,
        invoiceNumber: '@Model.InvoiceNumber',
        customerName: '@(Model.CustomerName ?? Model.Nickname ?? "Guest")',
        email: '@(email ?? "N/A")',
        location: '@(location ?? "N/A")',
        status: '@Model.Status'
    };

    console.log('=== Order Details ===');
    console.log('Order ID:', customerInfo.orderId);
    console.log('Invoice Number:', customerInfo.invoiceNumber);
    console.log('Customer:', customerInfo.customerName);
    console.log('Email:', customerInfo.email);
    console.log('Location:', customerInfo.location);
    console.log('Status:', customerInfo.status);

    @foreach (var item in Model.OrderItems)
    {
            if (item.Customizations != null && item.Customizations.Any())
            {
                    @:console.log('Item: @item.ProductName - Customizations:', @Html.Raw(System.Text.Json.JsonSerializer.Serialize(item.Customizations)));
            }
    }
    console.log('====================');
</script>